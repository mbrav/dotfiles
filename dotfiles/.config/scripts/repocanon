#!/usr/bin/env bash
set -euo pipefail

# Set script_dir
script_dir="$(dirname "$(realpath "$0")")"

# Source util functions
source "${script_dir}/_util"

ran_col_str "Utility for moving Git repositories to a canonical location"

reo_dir="${1:-$HOME/dev}"

echo "üîç Scanning for Git repositories under: $reo_dir"

find "$reo_dir" -type d -name ".git" | while read -r gitdir; do
	repo_root="$(dirname "$gitdir")"
	cd "$repo_root"

	# Try to get the remote origin URL
	remote_url="$(git remote get-url origin 2>/dev/null || true)"
	if [[ -z "$remote_url" ]]; then
		echo "‚ö†Ô∏è  Skipping: $repo_root (no remote origin)"
		continue
	fi

	# Normalize the remote URL
	if [[ "$remote_url" =~ ^git@([^:]+):(.+)\.git$ ]]; then
		host="${BASH_REMATCH[1]}"
		path="${BASH_REMATCH[2]}"
	elif [[ "$remote_url" =~ ^https?://([^/]+)/(.+)\.git$ ]]; then
		host="${BASH_REMATCH[1]}"
		path="${BASH_REMATCH[2]}"
	else
		echo "‚ùå Unknown remote format: $remote_url"
		continue
	fi

	target_path="$reo_dir/$host/$path"

	if [[ "$repo_root" == "$target_path" ]]; then
		echo "‚úÖ Already in correct location: $repo_root"
		continue
	fi

	echo "üöö Moving: $repo_root ‚Üí $target_path"
	mkdir -p "$(dirname "$target_path")"
	mv "$repo_root" "$target_path"
done

echo "‚úÖ Done."
